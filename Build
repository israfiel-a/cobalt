#!/bin/bash

cmake -B build . --toolchain Toolchain/Toolchain.cmake
cd build
cmake --build . --parallel 9

x86_64-elf-objcopy -I elf64-x86-64 -O efi-app-x86-64 ./Cobalt/Cobalt ./Cobalt/BOOTX64.efi
source ../Toolchain/CreateImage.sh Cobalt

if [ "$1" == "run" ]; then
    sudo qemu-system-x86_64 -machine q35 -m 256 -smp 2 -net none                                \
        -global driver=cfi.pflash01,property=secure,value=on                                    \
        -drive if=pflash,format=raw,unit=0,file=/usr/share/edk2/x64/OVMF_CODE.4m.fd,readonly=on \
        -drive if=pflash,format=raw,unit=1,file=/usr/share/edk2/x64/OVMF_VARS.4m.fd             \
        -drive if=ide,format=raw,file=Cobalt.img
fi